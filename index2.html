<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üé≠ Character Builder Studio üé≠</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Comic Sans MS', cursive, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            display: grid;
            grid-template-columns: 300px 1fr 300px;
            height: 100vh;
            gap: 10px;
            padding: 10px;
        }

        .asset-panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 15px;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .canvas-area {
            background: white;
            border-radius: 20px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            border: 4px solid #ff6b6b;
        }

        .canvas {
            width: 100%;
            height: 100%;
            position: relative;
            background: linear-gradient(45deg, #f0f8ff 25%, transparent 25%), 
                        linear-gradient(-45deg, #f0f8ff 25%, transparent 25%), 
                        linear-gradient(45deg, transparent 75%, #f0f8ff 75%), 
                        linear-gradient(-45deg, transparent 75%, #f0f8ff 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
        }

        .canvas-title {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 107, 107, 0.9);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 1.2em;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .panel-title {
            color: #4a4a4a;
            font-size: 1.3em;
            margin-bottom: 15px;
            text-align: center;
            border-bottom: 3px solid #ff6b6b;
            padding-bottom: 8px;
        }

        .asset-category {
            margin-bottom: 20px;
        }

        .category-title {
            color: #ff6b6b;
            font-size: 1.1em;
            margin-bottom: 10px;
            font-weight: bold;
            cursor: pointer;
            padding: 8px;
            background: rgba(255, 107, 107, 0.1);
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .category-title:hover {
            background: rgba(255, 107, 107, 0.2);
        }

        .category-title.collapsed::after {
            content: ' ‚ñº';
        }

        .category-title.expanded::after {
            content: ' ‚ñ≤';
        }

        .asset-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
            gap: 8px;
            transition: all 0.3s ease;
        }

        .asset-grid.hidden {
            display: none;
        }

        .asset-item {
            width: 60px;
            height: 60px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: grab;
            transition: all 0.3s ease;
            position: relative;
            font-size: 2em;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .asset-item:hover {
            transform: scale(1.1);
            border-color: #ff6b6b;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
        }

        .asset-item:active {
            cursor: grabbing;
        }

        .draggable-item {
            position: absolute;
            cursor: move;
            transition: transform 0.1s ease;
            z-index: 100;
            border: 2px solid transparent;
            border-radius: 8px;
            user-select: none;
        }

        .draggable-item:hover {
            border-color: #ff6b6b;
            transform: scale(1.05);
        }

        .draggable-item.selected {
            border-color: #4ecdc4;
            box-shadow: 0 0 15px rgba(78, 205, 196, 0.5);
        }

        .draggable-item .delete-btn {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 20px;
            height: 20px;
            background: #ff4757;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 12px;
            display: none;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .draggable-item:hover .delete-btn,
        .draggable-item.selected .delete-btn {
            display: flex;
        }

        .control-panel {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            z-index: 1000;
        }

        .control-btn {
            background: #4ecdc4;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-family: inherit;
            font-size: 1em;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .control-btn:hover {
            background: #45b7aa;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .clear-btn {
            background: #ff6b6b;
        }

        .clear-btn:hover {
            background: #ff5252;
        }

        .layers-info {
            position: absolute;
            top: 80px;
            right: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 10px;
            font-size: 0.9em;
            color: #666;
            max-width: 200px;
        }

        .size-controls {
            margin-top: 15px;
            padding: 10px;
            background: rgba(78, 205, 196, 0.1);
            border-radius: 10px;
        }

        .size-title {
            color: #4ecdc4;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .size-buttons {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .size-btn {
            background: white;
            border: 2px solid #4ecdc4;
            color: #4ecdc4;
            padding: 5px 10px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.8em;
            transition: all 0.3s ease;
        }

        .size-btn:hover {
            background: #4ecdc4;
            color: white;
        }

        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr auto;
                height: 100vh;
            }
            
            .asset-panel {
                max-height: 200px;
            }
            
            .canvas-area {
                min-height: 400px;
            }
        }

        .drag-helper {
            position: fixed;
            pointer-events: none;
            z-index: 10000;
            font-size: 2em;
            transform: translate(-50%, -50%);
            opacity: 0.8;
        }

        .drop-zone {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border: 3px dashed transparent;
            transition: all 0.3s ease;
        }

        .drop-zone.drag-over {
            border-color: #4ecdc4;
            background: rgba(78, 205, 196, 0.1);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Left Panel - Character Parts -->
        <div class="asset-panel">
            <h3 class="panel-title">üë§ Character Parts</h3>
            
            <div class="asset-category">
                <div class="category-title expanded" onclick="toggleCategory(this)">üë• Bodies</div>
                <div class="asset-grid">
                    <div class="asset-item" data-asset="üßç" data-category="body">üßç</div>
                    <div class="asset-item" data-asset="üßç‚Äç‚ôÄÔ∏è" data-category="body">üßç‚Äç‚ôÄÔ∏è</div>
                    <div class="asset-item" data-asset="üßç‚Äç‚ôÇÔ∏è" data-category="body">üßç‚Äç‚ôÇÔ∏è</div>
                    <div class="asset-item" data-asset="üë∂" data-category="body">üë∂</div>
                    <div class="asset-item" data-asset="üßí" data-category="body">üßí</div>
                    <div class="asset-item" data-asset="üëß" data-category="body">üëß</div>
                    <div class="asset-item" data-asset="üßë" data-category="body">üßë</div>
                    <div class="asset-item" data-asset="üë®" data-category="body">üë®</div>
                    <div class="asset-item" data-asset="üë©" data-category="body">üë©</div>
                    <div class="asset-item" data-asset="üßì" data-category="body">üßì</div>
                    <div class="asset-item" data-asset="üë¥" data-category="body">üë¥</div>
                    <div class="asset-item" data-asset="üëµ" data-category="body">üëµ</div>
                </div>
            </div>

            <div class="asset-category">
                <div class="category-title collapsed" onclick="toggleCategory(this)">üëó Clothes</div>
                <div class="asset-grid hidden">
                    <div class="asset-item" data-asset="üëî" data-category="clothes">üëî</div>
                    <div class="asset-item" data-asset="üëï" data-category="clothes">üëï</div>
                    <div class="asset-item" data-asset="üëñ" data-category="clothes">üëñ</div>
                    <div class="asset-item" data-asset="üëó" data-category="clothes">üëó</div>
                    <div class="asset-item" data-asset="üëò" data-category="clothes">üëò</div>
                    <div class="asset-item" data-asset="üëö" data-category="clothes">üëö</div>
                    <div class="asset-item" data-asset="üëô" data-category="clothes">üëô</div>
                    <div class="asset-item" data-asset="ü©±" data-category="clothes">ü©±</div>
                    <div class="asset-item" data-asset="ü©≤" data-category="clothes">ü©≤</div>
                    <div class="asset-item" data-asset="ü©≥" data-category="clothes">ü©≥</div>
                    <div class="asset-item" data-asset="üß•" data-category="clothes">üß•</div>
                    <div class="asset-item" data-asset="üß¶" data-category="clothes">üß¶</div>
                </div>
            </div>

            <div class="asset-category">
                <div class="category-title collapsed" onclick="toggleCategory(this)">üëü Shoes</div>
                <div class="asset-grid hidden">
                    <div class="asset-item" data-asset="üëü" data-category="shoes">üëü</div>
                    <div class="asset-item" data-asset="üë†" data-category="shoes">üë†</div>
                    <div class="asset-item" data-asset="üë°" data-category="shoes">üë°</div>
                    <div class="asset-item" data-asset="üë¢" data-category="shoes">üë¢</div>
                    <div class="asset-item" data-asset="üëû" data-category="shoes">üëû</div>
                    <div class="asset-item" data-asset="ü•ø" data-category="shoes">ü•ø</div>
                    <div class="asset-item" data-asset="ü©¥" data-category="shoes">ü©¥</div>
                    <div class="asset-item" data-asset="ü•æ" data-category="shoes">ü•æ</div>
                    <div class="asset-item" data-asset="ü©∞" data-category="shoes">ü©∞</div>
                </div>
            </div>

            <div class="asset-category">
                <div class="category-title collapsed" onclick="toggleCategory(this)">üé≠ Faces</div>
                <div class="asset-grid hidden">
                    <div class="asset-item" data-asset="üòÄ" data-category="face">üòÄ</div>
                    <div class="asset-item" data-asset="üòÉ" data-category="face">üòÉ</div>
                    <div class="asset-item" data-asset="üòÑ" data-category="face">üòÑ</div>
                    <div class="asset-item" data-asset="üòÅ" data-category="face">üòÅ</div>
                    <div class="asset-item" data-asset="üòÖ" data-category="face">üòÖ</div>
                    <div class="asset-item" data-asset="üòÇ" data-category="face">üòÇ</div>
                    <div class="asset-item" data-asset="üôÇ" data-category="face">üôÇ</div>
                    <div class="asset-item" data-asset="üòâ" data-category="face">üòâ</div>
                    <div class="asset-item" data-asset="üòä" data-category="face">üòä</div>
                    <div class="asset-item" data-asset="üòá" data-category="face">üòá</div>
                    <div class="asset-item" data-asset="üòã" data-category="face">üòã</div>
                    <div class="asset-item" data-asset="üòé" data-category="face">üòé</div>
                    <div class="asset-item" data-asset="ü§ì" data-category="face">ü§ì</div>
                    <div class="asset-item" data-asset="üòê" data-category="face">üòê</div>
                    <div class="asset-item" data-asset="üòï" data-category="face">üòï</div>
                    <div class="asset-item" data-asset="üòü" data-category="face">üòü</div>
                    <div class="asset-item" data-asset="üòÆ" data-category="face">üòÆ</div>
                    <div class="asset-item" data-asset="üòØ" data-category="face">üòØ</div>
                </div>
            </div>

            <div class="size-controls">
                <div class="size-title">üìè Resize Selected:</div>
                <div class="size-buttons">
                    <button class="size-btn" onclick="resizeSelected(0.5)">Tiny</button>
                    <button class="size-btn" onclick="resizeSelected(0.8)">Small</button>
                    <button class="size-btn" onclick="resizeSelected(1)">Normal</button>
                    <button class="size-btn" onclick="resizeSelected(1.5)">Big</button>
                    <button class="size-btn" onclick="resizeSelected(2)">Huge</button>
                </div>
            </div>
        </div>

        <!-- Center - Canvas -->
        <div class="canvas-area">
            <div class="canvas-title">üé® Drag & Drop Character Builder üé®</div>
            <div class="canvas" id="canvas">
                <div class="drop-zone" id="dropZone"></div>
            </div>
            <div class="control-panel">
                <button class="control-btn" onclick="saveCharacter()">üíæ Save</button>
                <button class="control-btn clear-btn" onclick="clearCanvas()">üóëÔ∏è Clear All</button>
                <button class="control-btn" onclick="randomCharacter()">üé≤ Random</button>
            </div>
            <div class="layers-info">
                <strong>üí° Tips:</strong><br>
                ‚Ä¢ Drag items from the panels<br>
                ‚Ä¢ Click items to select/move<br>
                ‚Ä¢ Use resize buttons<br>
                ‚Ä¢ Layer items on top of each other<br>
                ‚Ä¢ Have fun creating!
            </div>
        </div>

        <!-- Right Panel - Accessories & Effects -->
        <div class="asset-panel">
            <h3 class="panel-title">‚ú® Accessories & More</h3>
            
            <div class="asset-category">
                <div class="category-title expanded" onclick="toggleCategory(this)">üëë Hats & Hair</div>
                <div class="asset-grid">
                    <div class="asset-item" data-asset="üëë" data-category="hat">üëë</div>
                    <div class="asset-item" data-asset="üëí" data-category="hat">üëí</div>
                    <div class="asset-item" data-asset="üéì" data-category="hat">üéì</div>
                    <div class="asset-item" data-asset="üß¢" data-category="hat">üß¢</div>
                    <div class="asset-item" data-asset="‚õëÔ∏è" data-category="hat">‚õëÔ∏è</div>
                    <div class="asset-item" data-asset="üé©" data-category="hat">üé©</div>
                    <div class="asset-item" data-asset="üë∂" data-category="hair">üë∂</div>
                    <div class="asset-item" data-asset="ü¶≥" data-category="hair">ü¶≥</div>
                    <div class="asset-item" data-asset="ü¶≤" data-category="hair">ü¶≤</div>
                </div>
            </div>

            <div class="asset-category">
                <div class="category-title collapsed" onclick="toggleCategory(this)">üï∂Ô∏è Glasses & Eyes</div>
                <div class="asset-grid hidden">
                    <div class="asset-item" data-asset="üï∂Ô∏è" data-category="glasses">üï∂Ô∏è</div>
                    <div class="asset-item" data-asset="üëì" data-category="glasses">üëì</div>
                    <div class="asset-item" data-asset="ü•Ω" data-category="glasses">ü•Ω</div>
                    <div class="asset-item" data-asset="üëÅÔ∏è" data-category="eyes">üëÅÔ∏è</div>
                    <div class="asset-item" data-asset="üëÄ" data-category="eyes">üëÄ</div>
                </div>
            </div>

            <div class="asset-category">
                <div class="category-title collapsed" onclick="toggleCategory(this)">üéí Bags & Items</div>
                <div class="asset-grid hidden">
                    <div class="asset-item" data-asset="üéí" data-category="bag">üéí</div>
                    <div class="asset-item" data-asset="üëú" data-category="bag">üëú</div>
                    <div class="asset-item" data-asset="üëù" data-category="bag">üëù</div>
                    <div class="asset-item" data-asset="üõçÔ∏è" data-category="bag">üõçÔ∏è</div>
                    <div class="asset-item" data-asset="üíº" data-category="bag">üíº</div>
                    <div class="asset-item" data-asset="‚öΩ" data-category="item">‚öΩ</div>
                    <div class="asset-item" data-asset="üèÄ" data-category="item">üèÄ</div>
                    <div class="asset-item" data-asset="üì±" data-category="item">üì±</div>
                    <div class="asset-item" data-asset="üéÆ" data-category="item">üéÆ</div>
                    <div class="asset-item" data-asset="üìö" data-category="item">üìö</div>
                </div>
            </div>

            <div class="asset-category">
                <div class="category-title collapsed" onclick="toggleCategory(this)">üåü Magic & Fantasy</div>
                <div class="asset-grid hidden">
                    <div class="asset-item" data-asset="üßô‚Äç‚ôÄÔ∏è" data-category="fantasy">üßô‚Äç‚ôÄÔ∏è</div>
                    <div class="asset-item" data-asset="üßô‚Äç‚ôÇÔ∏è" data-category="fantasy">üßô‚Äç‚ôÇÔ∏è</div>
                    <div class="asset-item" data-asset="üßö‚Äç‚ôÄÔ∏è" data-category="fantasy">üßö‚Äç‚ôÄÔ∏è</div>
                    <div class="asset-item" data-asset="üßö‚Äç‚ôÇÔ∏è" data-category="fantasy">üßö‚Äç‚ôÇÔ∏è</div>
                    <div class="asset-item" data-asset="ü¶∏‚Äç‚ôÄÔ∏è" data-category="fantasy">ü¶∏‚Äç‚ôÄÔ∏è</div>
                    <div class="asset-item" data-asset="ü¶∏‚Äç‚ôÇÔ∏è" data-category="fantasy">ü¶∏‚Äç‚ôÇÔ∏è</div>
                    <div class="asset-item" data-asset="ü¶π‚Äç‚ôÄÔ∏è" data-category="fantasy">ü¶π‚Äç‚ôÄÔ∏è</div>
                    <div class="asset-item" data-asset="ü¶π‚Äç‚ôÇÔ∏è" data-category="fantasy">ü¶π‚Äç‚ôÇÔ∏è</div>
                    <div class="asset-item" data-asset="‚≠ê" data-category="effect">‚≠ê</div>
                    <div class="asset-item" data-asset="‚ú®" data-category="effect">‚ú®</div>
                    <div class="asset-item" data-asset="üí´" data-category="effect">üí´</div>
                    <div class="asset-item" data-asset="üåü" data-category="effect">üåü</div>
                    <div class="asset-item" data-asset="üíñ" data-category="effect">üíñ</div>
                    <div class="asset-item" data-asset="üíù" data-category="effect">üíù</div>
                    <div class="asset-item" data-asset="üéÅ" data-category="effect">üéÅ</div>
                </div>
            </div>

            <div class="asset-category">
                <div class="category-title collapsed" onclick="toggleCategory(this)">üêæ Animals & Pets</div>
                <div class="asset-grid hidden">
                    <div class="asset-item" data-asset="üê∂" data-category="animal">üê∂</div>
                    <div class="asset-item" data-asset="üê±" data-category="animal">üê±</div>
                    <div class="asset-item" data-asset="üê≠" data-category="animal">üê≠</div>
                    <div class="asset-item" data-asset="üêπ" data-category="animal">üêπ</div>
                    <div class="asset-item" data-asset="üê∞" data-category="animal">üê∞</div>
                    <div class="asset-item" data-asset="ü¶ä" data-category="animal">ü¶ä</div>
                    <div class="asset-item" data-asset="üêª" data-category="animal">üêª</div>
                    <div class="asset-item" data-asset="üêº" data-category="animal">üêº</div>
                    <div class="asset-item" data-asset="üê®" data-category="animal">üê®</div>
                    <div class="asset-item" data-asset="üêØ" data-category="animal">üêØ</div>
                    <div class="asset-item" data-asset="ü¶Å" data-category="animal">ü¶Å</div>
                    <div class="asset-item" data-asset="üê∏" data-category="animal">üê∏</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let draggedAsset = null;
        let selectedElement = null;
        let dragHelper = null;
        let canvasItems = [];
        let itemCounter = 0;

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            initializeDragAndDrop();
            setupCanvasInteractions();
        });

        function initializeDragAndDrop() {
            // Add drag functionality to asset items
            document.querySelectorAll('.asset-item').forEach(item => {
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('drag', handleDrag);
                item.addEventListener('dragend', handleDragEnd);
                item.draggable = true;
            });

            // Setup canvas drop zone
            const dropZone = document.getElementById('dropZone');
            dropZone.addEventListener('dragover', handleDragOver);
            dropZone.addEventListener('dragenter', handleDragEnter);
            dropZone.addEventListener('dragleave', handleDragLeave);
            dropZone.addEventListener('drop', handleDrop);
        }

        function handleDragStart(e) {
            draggedAsset = e.target.dataset.asset;
            
            // Create drag helper
            dragHelper = document.createElement('div');
            dragHelper.className = 'drag-helper';
            dragHelper.textContent = draggedAsset;
            document.body.appendChild(dragHelper);
            
            e.dataTransfer.effectAllowed = 'copy';
        }

        function handleDrag(e) {
            if (dragHelper && e.clientX && e.clientY) {
                dragHelper.style.left = e.clientX + 'px';
                dragHelper.style.top = e.clientY + 'px';
            }
        }

        function handleDragEnd(e) {
            if (dragHelper) {
                document.body.removeChild(dragHelper);
                dragHelper = null;
            }
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'copy';
        }

        function handleDragEnter(e) {
            e.preventDefault();
            e.target.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            if (!e.target.contains(e.relatedTarget)) {
                e.target.classList.remove('drag-over');
            }
        }

        function handleDrop(e) {
            e.preventDefault();
            e.target.classList.remove('drag-over');
            
            if (draggedAsset) {
                const canvas = document.getElementById('canvas');
                const rect = canvas.getBoundingClientRect();
                
                // Calculate position relative to canvas
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                createCanvasItem(draggedAsset, x, y);
                draggedAsset = null;
            }
        }

        function createCanvasItem(asset, x, y) {
            const canvas = document.getElementById('canvas');
            const item = document.createElement('div');
            const itemId = 'item-' + (++itemCounter);
            
            item.className = 'draggable-item';
            item.id = itemId;
            item.textContent = asset;
            item.style.left = Math.max(0, Math.min(x - 30, canvas.clientWidth - 60)) + 'px';
            item.style.top = Math.max(0, Math.min(y - 30, canvas.clientHeight - 60)) + 'px';
            item.style.fontSize = '3em';
            item.style.zIndex = 100 + canvasItems.length;
            
            // Add delete button
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-btn';
            deleteBtn.innerHTML = '√ó';
            deleteBtn.onclick = () => removeCanvasItem(itemId);
            item.appendChild(deleteBtn);
            
            canvas.appendChild(item);
            
            // Store item data
            canvasItems.push({
                id: itemId,
                asset: asset,
                x: parseFloat(item.style.left),
                y: parseFloat(item.style.top),
                scale: 1
            });
            
            // Add click handler for selection
            item.addEventListener('click', (e) => {
                e.stopPropagation();
                selectItem(itemId);
            });
            
            // Make it draggable within canvas
            makeItemDraggable(item);
        }

        function makeItemDraggable(item) {
            let isDragging = false;
            let startX, startY, initialX, initialY;
            
            item.addEventListener('mousedown', (e) => {
                if (e.target.classList.contains('delete-btn')) return;
                
                isDragging = true;
                startX = e.clientX;
                startY = e.clientY;
                initialX = parseFloat(item.style.left) || 0;
                initialY = parseFloat(item.style.top) || 0;
                
                selectItem(item.id);
                
                document.addEventListener('mousemove', handleMouseMove);
                document.addEventListener('mouseup', handleMouseUp);
                
                e.preventDefault();
            });
            
            function handleMouseMove(e) {
                if (!isDragging) return;
                
                const dx = e.clientX - startX;
                const dy = e.clientY - startY;
                
                const newX = Math.max(0, Math.min(initialX + dx, document.getElementById('canvas').clientWidth - 60));
                const newY = Math.max(0, Math.min(initialY + dy, document.getElementById('canvas').clientHeight - 60));
                
                item.style.left = newX + 'px';
                item.style.top = newY + 'px';
                
                // Update stored position
                const itemData = canvasItems.find(i => i.id === item.id);
                if (itemData) {
                    itemData.x = newX;
                    itemData.y = newY;
                }
            }
            
            function handleMouseUp() {
                isDragging = false;
                document.removeEventListener('mousemove', handleMouseMove);
                document.removeEventListener('mouseup', handleMouseUp);
            }
        }

        function setupCanvasInteractions() {
            // Click canvas to deselect
            document.getElementById('canvas').addEventListener('click', (e) => {
                if (e.target.id === 'canvas' || e.target.id === 'dropZone') {
                    deselectAll();
                }
            });
        }

        function selectItem(itemId) {
            // Deselect all items
            deselectAll();
            
            // Select the clicked item
            const item = document.getElementById(itemId);
            if (item) {
                item.classList.add('selected');
                selectedElement = itemId;
            }
        }

        function deselectAll() {
            document.querySelectorAll('.draggable-item').forEach(item => {
                item.classList.remove('selected');
            });
            selectedElement = null;
        }

        function removeCanvasItem(itemId) {
            const item = document.getElementById(itemId);
            if (item) {
                item.remove();
                canvasItems = canvasItems.filter(i => i.id !== itemId);
                
                if (selectedElement === itemId) {
                    selectedElement = null;
                }
            }
        }

        function toggleCategory(element) {
            const grid = element.nextElementSibling;
            
            if (element.classList.contains('collapsed')) {
                element.classList.remove('collapsed');
                element.classList.add('expanded');
                grid.classList.remove('hidden');
            } else {
                element.classList.remove('expanded');
                element.classList.add('collapsed');
                grid.classList.add('hidden');
            }
        }

        function resizeSelected(scale) {
            if (!selectedElement) {
                alert('Please select an item first by clicking on it!');
                return;
            }
            
            const item = document.getElementById(selectedElement);
            if (item) {
                const newSize = 3 * scale; // Base size is 3em
                item.style.fontSize = newSize + 'em';
                
                // Update stored scale
                const itemData = canvasItems.find(i => i.id === selectedElement);
                if (itemData) {
                    itemData.scale = scale;
                }
            }
        }

        function clearCanvas() {
            if (confirm('Are you sure you want to clear all items?')) {
                document.querySelectorAll('.draggable-item').forEach(item => {
                    item.remove();
                });
                canvasItems = [];
                selectedElement = null;
            }
        }

        function saveCharacter() {
            if (canvasItems.length === 0) {
                alert('Add some items to your character first!');
                return;
            }
            
            // Create a simple save data
            const saveData = {
                items: canvasItems,
                timestamp: new Date().toISOString()
            };
            
            // For demo purposes, just show the data
            alert('Character saved! Items: ' + canvasItems.map(item => item.asset).join(' '));
            
            // In a real app, you could save to localStorage or send to a server
            localStorage.setItem('character-builder-save', JSON.stringify(saveData));
        }

        function randomCharacter() {
            // Clear canvas first
            clearCanvas();
            
            // Define some random character combinations
            const randomCombos = [
                [
                    { asset: 'üßç‚Äç‚ôÄÔ∏è', x: 200, y: 150, scale: 1.5 },
                    { asset: 'üëë', x: 215, y: 130, scale: 1 },
                    { asset: 'üëó', x: 210, y: 200, scale: 1.2 },
                    { asset: 'üë†', x: 205, y: 280, scale: 1 }
                ],
                [
                    { asset: 'üßç‚Äç‚ôÇÔ∏è', x: 200, y: 150, scale: 1.5 },
                    { asset: 'üß¢', x: 215, y: 130, scale: 1 },
                    { asset: 'üëï', x: 210, y: 200, scale: 1.2 },
                    { asset: 'üëñ', x: 210, y: 240, scale: 1.2 },
                    { asset: 'üëü', x: 205, y: 280, scale: 1 }
                ],
                [
                    { asset: 'üßö‚Äç‚ôÄÔ∏è', x: 200, y: 150, scale: 1.5 },
                    { asset: '‚ú®', x: 150, y: 120, scale: 0.8 },
                    { asset: '‚≠ê', x: 280, y: 140, scale: 0.8 },
                    { asset: 'üåü', x: 160, y: 200, scale: 0.8 }
                ]
            ];
            
            const randomCombo = randomCombos[Math.floor(Math.random() * randomCombos.length)];
            
            randomCombo.forEach(item => {
                createCanvasItem(item.asset, item.x, item.y);
                // Apply scale after creation
                setTimeout(() => {
                    const lastItem = document.getElementById('item-' + itemCounter);
                    if (lastItem) {
                        lastItem.style.fontSize = (3 * item.scale) + 'em';
                    }
                }, 10);
            });
        }

        // Load saved character on page load
        function loadSavedCharacter() {
            const saved = localStorage.getItem('character-builder-save');
            if (saved) {
                try {
                    const saveData = JSON.parse(saved);
                    if (saveData.items && saveData.items.length > 0) {
                        saveData.items.forEach(item => {
                            createCanvasItem(item.asset, item.x, item.y);
                            // Apply saved scale
                            setTimeout(() => {
                                const lastItem = document.getElementById('item-' + itemCounter);
                                if (lastItem) {
                                    lastItem.style.fontSize = (3 * item.scale) + 'em';
                                }
                            }, 10);
                        });
                    }
                } catch (e) {
                    console.log('Could not load saved character');
                }
            }
        }

        // Auto-load saved character
        setTimeout(loadSavedCharacter, 500);
